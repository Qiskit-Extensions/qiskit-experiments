<!DOCTYPE html>
  <html class="no-js" lang="en" >
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>qiskit_experiments.framework.experiment_data &mdash; Qiskit Experiments 0.5 0.5.4</title>
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" /><link rel="modulepreload" href="https://cdn.jsdelivr.net/npm/@qiskit/web-components/experimental-bundled-ui-shell.js">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@qiskit/web-components/experimental-bundled-ui-shell.js"></script>
  <style>
    qiskit-ui-shell:not(:defined) {
      display: block;
      margin-bottom: 3.5rem;
    }
  </style>

  <!-- SEGMENT ANALYTICS -->
    <script>
      (function () {
        window._analytics = {
          segment_key: 'ffdYLviQze3kzomaINXNk6NwpY9LlXcw',
          coremetrics: false,
          optimizely: false,
          googleAddServices: false,
          fullStory: false,
          autoPageEventSpa: false,
          autoFormEvents: false,
          autoPageView: false
        }

        window.digitalData = {
          page: {
            pageInfo: {
              productTitle: 'IBM Q Experience',
              analytics: {
                category: 'Qiskit.org'
              }
            }
          }
        }
      }());
    </script>
    <script src="https://cloud.ibm.com/analytics/build/bluemix-analytics.min.js"></script>
    <script>
      (function () {
        'use strict'

        if (!window.bluemixAnalytics || !window.digitalData) { return }

        const category = window.digitalData.page.pageInfo.analytics.category
        const productTitle = window.digitalData.page.pageInfo.productTitle
        const routeName = 'documentation'

        window.bluemixAnalytics.pageEvent(category, routeName, {
          navigationType: 'pushState',
          productTitle: productTitle,
          title: document.title
        })

        window.trackCta = (action) => {
          if (!window.bluemixAnalytics || !window.digitalData) { return }

          const category = window.digitalData.page.pageInfo.analytics.category
          const productTitle = window.digitalData.page.pageInfo.productTitle

          window.bluemixAnalytics.trackEvent('CTA Clicked', {
            productTitle,
            category,
            CTA: action
          })
        }

      }());
    </script></head>
<body class="pytorch-body">
  <!-- UNIFIED TOP MENU -->
  <qiskit-ui-shell variant="hide-account"></qiskit-ui-shell>

   

    <!-- LEFT SIDE BAR -->

    <!-- if translations available, display language dropdown menu -->
    

    <!-- Menu becomes dropdown in mobile view -->
    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <!-- left side bar main content -->
    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
    <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
      <div class="sidebar">
    <div class="pytorch-left-menu-search">
        <div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Qiskit Experiments 0.5 Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    </div>

    <!-- render sidebar from the toctree -->
    
    
        <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">All Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/calibrations.html">Calibrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/data_processor.html">Data Processor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/curve_analysis.html">Curve Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/custom_experiment.html">Custom Experiments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../howtos/index.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manuals/index.html">Experiment Manuals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidocs/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Qiskit/qiskit-experiments">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://qiskit.org/documentation/experiments/dev">Development Branch Docs</a></li>
</ul>

    

    <!-- PREVIOUS RELEASES -->
        

    </div>
  </div>
</nav>

<!-- OPTIONAL EXPANDABLE FUNCTIONALITY -->

<script>
    var expandable_rows = document.getElementsByClassName("caption");
    var i;
    var j;
    for (i = 0; i < expandable_rows.length; i++) {
        // add the chevron icon
        expandable_rows[i].classList.add("expandable")
        // expand the dropdown if user is currently on a page included in the dropdown
        var subheadings = expandable_rows[i].nextElementSibling
        if (subheadings.classList.contains("current")) {
            subheadings.style.display = "block"
            subheadings.style.marginLeft = "0.5rem";
            expandable_rows[i].classList.add("open");
        } else {subheadings.style.display = "none"}

        // expand and unexpand dropdown when clicked
        expandable_rows[i].addEventListener("click", function() {
            this.classList.toggle("open");
            var clicked_subheadings = this.nextElementSibling;
            if (clicked_subheadings.style.display === "block") {
            clicked_subheadings.style.display = "none";
            } else {
            clicked_subheadings.style.display = "block";
            }
        });

    }
</script>


<!-- STYLING -->
<script>
    // indent subheadings under captions
    expandable_rows = document.getElementsByClassName("caption");
    var i;
    for (i = 0; i < expandable_rows.length; i++) {
        expandable_rows[i].nextElementSibling.style.marginLeft = "1rem"

        // un-bold subheadings in dropdown
        var subheadings = expandable_rows[i].nextElementSibling
        for (j = 0; j < subheadings.children.length; j++) {
            subheadings.children[j].style.fontWeight = "unset"
        }
    }

    // adjust toctree class name to style external links
    var toc_rows = document.getElementsByClassName("toctree-l1");
    var i;
    for (i = 0; i < toc_rows.length; i++) {
        if (toc_rows[i].children[0].className === "reference external") {
            toc_rows[i].className = "toctree-l1-external"
            }
    }

    // expand and unexpand previous releases dropdown when clicked
    var release_rows = document.getElementsByClassName("sidebar-l1-expandable");
    for (i = 0; i < expandable_rows.length; i++) {
        release_rows[i].addEventListener("click", function() {
            this.classList.toggle("open");
            var clicked_subheadings = this.nextElementSibling;
            if (clicked_subheadings.style.display === "block") {
            clicked_subheadings.style.display = "none";
            } else {
            clicked_subheadings.style.display = "block";
            }
        });
    }
</script>

    <div class="pytorch-container">

      <!-- BREADCRUMB MINI MENU BELOW TOP NAV BAR -->
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          <div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
            Qiskit Experiments 0.5 documentation
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
      <li>qiskit_experiments.framework.experiment_data</li>
    
  </ul>
</div>
        </div>
      </div>

      <!-- MAIN CENTRE CONTENT -->
      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        
        <div class="pytorch-content-left">
          <div class="rst-content">
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for qiskit_experiments.framework.experiment_data</h1><div class="highlight"><pre>
<span></span><span class="c1"># This code is part of Qiskit.</span>
<span class="c1">#</span>
<span class="c1"># (C) Copyright IBM 2021.</span>
<span class="c1">#</span>
<span class="c1"># This code is licensed under the Apache License, Version 2.0. You may</span>
<span class="c1"># obtain a copy of this license in the LICENSE.txt file in the root directory</span>
<span class="c1"># of this source tree or at http://www.apache.org/licenses/LICENSE-2.0.</span>
<span class="c1">#</span>
<span class="c1"># Any modifications or derivative works of this code must retain this</span>
<span class="c1"># copyright notice, and modified files need to carry a notice indicating</span>
<span class="c1"># that they have been altered from the originals.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Experiment Data class</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span> <span class="k">as</span> <span class="n">MatplotlibFigure</span>
<span class="kn">from</span> <span class="nn">qiskit.result</span> <span class="kn">import</span> <span class="n">Result</span>
<span class="kn">from</span> <span class="nn">qiskit.providers.jobstatus</span> <span class="kn">import</span> <span class="n">JobStatus</span><span class="p">,</span> <span class="n">JOB_FINAL_STATES</span>
<span class="kn">from</span> <span class="nn">qiskit.exceptions</span> <span class="kn">import</span> <span class="n">QiskitError</span>
<span class="kn">from</span> <span class="nn">qiskit.providers</span> <span class="kn">import</span> <span class="n">Job</span><span class="p">,</span> <span class="n">Backend</span><span class="p">,</span> <span class="n">Provider</span>

<span class="kn">from</span> <span class="nn">qiskit_ibm_experiment</span> <span class="kn">import</span> <span class="n">IBMExperimentService</span>
<span class="kn">from</span> <span class="nn">qiskit_ibm_experiment</span> <span class="kn">import</span> <span class="n">ExperimentData</span> <span class="k">as</span> <span class="n">ExperimentDataclass</span>
<span class="kn">from</span> <span class="nn">qiskit_experiments.framework.json</span> <span class="kn">import</span> <span class="n">ExperimentEncoder</span><span class="p">,</span> <span class="n">ExperimentDecoder</span>
<span class="kn">from</span> <span class="nn">qiskit_experiments.database_service.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">qiskit_version</span><span class="p">,</span>
    <span class="n">plot_to_svg_bytes</span><span class="p">,</span>
    <span class="n">ThreadSafeOrderedDict</span><span class="p">,</span>
    <span class="n">ThreadSafeList</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">qiskit_experiments.framework.analysis_result</span> <span class="kn">import</span> <span class="n">AnalysisResult</span>
<span class="kn">from</span> <span class="nn">qiskit_experiments.framework</span> <span class="kn">import</span> <span class="n">BackendData</span>
<span class="kn">from</span> <span class="nn">qiskit_experiments.database_service.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExperimentDataError</span><span class="p">,</span>
    <span class="n">ExperimentEntryNotFound</span><span class="p">,</span>
    <span class="n">ExperimentEntryExists</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="c1"># There is a cyclical dependency here, but the name needs to exist for</span>
    <span class="c1"># Sphinx on Python 3.9+ to link type hints correctly.  The gating on</span>
    <span class="c1"># `TYPE_CHECKING` means that the import will never be resolved by an actual</span>
    <span class="c1"># interpreter, only static analysis.</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">BaseExperiment</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">do_auto_save</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorate the input function to auto save data.&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">return_val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">return_val</span>

    <span class="k">return</span> <span class="n">_wrapped</span>


<div class="viewcode-block" id="FigureData"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.FigureData.html#qiskit_experiments.framework.FigureData">[docs]</a><span class="k">class</span> <span class="nc">FigureData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper class for figures and figure metadata. The raw figure can be accessed with</span>
<span class="sd">    the ``figure`` attribute.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new figure data object.</span>

<span class="sd">        Args:</span>
<span class="sd">            figure: the raw figure itself. Can be SVG or matplotlib.Figure.</span>
<span class="sd">            name: Optional, the name of the figure.</span>
<span class="sd">            metadata: Optional, any metadata to be stored with the figure.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">figure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="c1"># name is read only</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The name of the figure&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The metadata dictionary stored with the figure&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

    <span class="nd">@metadata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the metadata to new value; must be a dictionary&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_metadata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;figure metadata must be a dictionary&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">new_metadata</span>

<div class="viewcode-block" id="FigureData.copy"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.FigureData.copy.html#qiskit_experiments.framework.FigureData.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a copy of the figure data&quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="n">FigureData</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__json_encode__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the json representation of the figure data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;figure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__json_decode__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;FigureData&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a figure data from the json representation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_png_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">MatplotlibFigure</span><span class="p">):</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">png</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">png</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_repr_svg_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ExperimentData"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.html#qiskit_experiments.framework.ExperimentData">[docs]</a><span class="k">class</span> <span class="nc">ExperimentData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Experiment data container class.</span>

<span class="sd">    This class handles the following:</span>

<span class="sd">    1. Storing the data related to an experiment: raw data, metadata, analysis results,</span>
<span class="sd">       and figures</span>
<span class="sd">    2. Managing jobs and adding data from jobs automatically</span>
<span class="sd">    3. Saving and loading data from the database service</span>

<span class="sd">    |</span>

<span class="sd">    The field ``db_data`` is a dataclass (``ExperimentDataclass``) containing</span>
<span class="sd">    all the data that can be stored in the database and loaded from it, and</span>
<span class="sd">    as such is subject to strict conventions.</span>

<span class="sd">    Other data fields can be added and used freely, but they won&#39;t be saved</span>
<span class="sd">    to the database.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_metadata_version</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">_job_executor</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span>

    <span class="n">_json_encoder</span> <span class="o">=</span> <span class="n">ExperimentEncoder</span>
    <span class="n">_json_decoder</span> <span class="o">=</span> <span class="n">ExperimentDecoder</span>

    <span class="n">_metadata_filename</span> <span class="o">=</span> <span class="s2">&quot;metadata.json&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;BaseExperiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Backend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">service</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IBMExperimentService</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">child_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ExperimentData</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">db_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExperimentDataclass</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize experiment data.</span>

<span class="sd">        Args:</span>
<span class="sd">            experiment: Experiment object that generated the data.</span>
<span class="sd">            backend: Backend the experiment runs on. This overrides the</span>
<span class="sd">                backend in the experiment object.</span>
<span class="sd">            service: The service that stores the experiment results to the database</span>
<span class="sd">            parent_id: ID of the parent experiment data</span>
<span class="sd">                in the setting of a composite experiment</span>
<span class="sd">            job_ids: IDs of jobs submitted for the experiment.</span>
<span class="sd">            child_data: List of child experiment data.</span>
<span class="sd">            verbose: Whether to print messages.</span>
<span class="sd">            db_data: A prepared ExperimentDataclass of the experiment info.</span>
<span class="sd">                This overrides other db parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span> <span class="ow">or</span> <span class="n">experiment</span><span class="o">.</span><span class="n">backend</span>
            <span class="n">experiment_type</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">experiment_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">experiment_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">job_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_experiment</span> <span class="o">=</span> <span class="n">experiment</span>

        <span class="c1"># data stored in the database</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">experiment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">_metadata</span><span class="p">())</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
            <span class="s2">&quot;_source&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;metadata_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_metadata_version</span><span class="p">,</span>
                <span class="s2">&quot;qiskit_version&quot;</span><span class="p">:</span> <span class="n">qiskit_version</span><span class="p">(),</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">experiment_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;experiment_id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">db_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span> <span class="o">=</span> <span class="n">ExperimentDataclass</span><span class="p">(</span>
                <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="n">experiment_type</span><span class="o">=</span><span class="n">experiment_type</span><span class="p">,</span>
                <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span>
                <span class="n">job_ids</span><span class="o">=</span><span class="n">job_ids</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span> <span class="o">=</span> <span class="n">db_data</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Key &#39;</span><span class="si">%s</span><span class="s2">&#39; not stored in the database&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># general data related</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_service_from_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_save</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_created_in_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_data</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="c1"># job handling related</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="c1"># Set 2 workers for analysis executor so there can be 1 actively running</span>
        <span class="c1"># future and one waiting &quot;running&quot; future. This is to allow the second</span>
        <span class="c1"># future to be cancelled without waiting for the actively running future</span>
        <span class="c1"># to finish first.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_executor</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_executor</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span>

        <span class="c1"># data storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span> <span class="o">=</span> <span class="n">ThreadSafeList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">figure_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_figures</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_analysis_results</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

        <span class="c1"># Child related</span>
        <span class="c1"># Add component data and set parent ID to current container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">child_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_child_data</span><span class="p">(</span><span class="n">child_data</span><span class="p">)</span>

    <span class="c1"># Getters/setters for experiment metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">experiment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the experiment for this data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            BaseExperiment: the experiment object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">completion_times</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the completion times of the jobs.&quot;&quot;&quot;</span>
        <span class="n">job_times</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;COMPLETED&quot;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">time_per_step</span><span class="p">():</span>
                <span class="n">job_times</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">time_per_step</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COMPLETED&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_times</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return tags assigned to this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of tags assigned to this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">tags</span>

    <span class="nd">@tags</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set tags for this experiment.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_tags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ExperimentDataError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The `tags` field of </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> must be a list.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">new_tags</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return experiment metadata.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Experiment metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">metadata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">creation_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the creation datetime of this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The creation datetime of this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">creation_datetime</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the start datetime of this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The start datetime of this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">start_datetime</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">updated_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the update datetime of this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The update datetime of this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">updated_datetime</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the end datetime of this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The end datetime of this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">end_datetime</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hub</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the hub of this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The hub of this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">hub</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the group of this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The group of this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">group</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the project of this experiment data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The project of this experiment data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">project</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Provider</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the provider.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Provider used for the experiment, or ``None`` if unknown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">provider</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">experiment_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return experiment ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            Experiment ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">experiment_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">experiment_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return experiment type</span>

<span class="sd">        Returns:</span>
<span class="sd">            Experiment type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">experiment_type</span>

    <span class="nd">@experiment_type</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">experiment_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the parent id&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">experiment_type</span> <span class="o">=</span> <span class="n">new_type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return parent experiment ID</span>

<span class="sd">        Returns:</span>
<span class="sd">            Parent ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">parent_id</span>

    <span class="nd">@parent_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">parent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the parent id&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="n">new_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">job_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return experiment job IDs.</span>

<span class="sd">        Returns: IDs of jobs submitted for this experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">job_ids</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">figure_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return names of the figures associated with this experiment.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Names of figures associated with this experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">figure_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">share_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the share level for this experiment</span>

<span class="sd">        Returns:</span>
<span class="sd">            Experiment share level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">share_level</span>

    <span class="nd">@share_level</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">share_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the experiment share level,</span>
<span class="sd">           to this experiment itself and its descendants.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_level: New experiment share level. Valid share levels are provider-</span>
<span class="sd">                specified. For example, IBM Quantum experiment service allows</span>
<span class="sd">                &quot;public&quot;, &quot;hub&quot;, &quot;group&quot;, &quot;project&quot;, and &quot;private&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">share_level</span> <span class="o">=</span> <span class="n">new_level</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">original_auto_save</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">auto_save</span>
            <span class="n">data</span><span class="o">.</span><span class="n">auto_save</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">data</span><span class="o">.</span><span class="n">share_level</span> <span class="o">=</span> <span class="n">new_level</span>
            <span class="n">data</span><span class="o">.</span><span class="n">auto_save</span> <span class="o">=</span> <span class="n">original_auto_save</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">notes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return experiment notes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Experiment notes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">notes</span>

    <span class="nd">@notes</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">notes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_notes</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update experiment notes.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_notes: New experiment notes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">notes</span> <span class="o">=</span> <span class="n">new_notes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backend_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the backend&#39;s name&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">backend</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Backend</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return backend.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Backend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span>

    <span class="nd">@backend</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_backend</span><span class="p">:</span> <span class="n">Backend</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update backend.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_backend: New backend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_backend</span><span class="p">(</span><span class="n">new_backend</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_backend</span><span class="p">:</span> <span class="n">Backend</span><span class="p">,</span> <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set backend.</span>
<span class="sd">        Args:</span>
<span class="sd">            new_backend: New backend.</span>
<span class="sd">            recursive: should set the backend for children as well</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># defined independently from the setter to enable setting without autosave</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">new_backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend_data</span> <span class="o">=</span> <span class="n">BackendData</span><span class="p">(</span><span class="n">new_backend</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend_data</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_backend</span><span class="p">)</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend_data</span><span class="o">.</span><span class="n">provider</span>
        <span class="k">if</span> <span class="n">provider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_hgp_from_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_data</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">_set_backend</span><span class="p">(</span><span class="n">new_backend</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_hgp_from_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hub</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">project</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># qiskit-ibmq-provider style</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="s2">&quot;credentials&quot;</span><span class="p">):</span>
                <span class="n">creds</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">credentials</span>
                <span class="n">hub</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">hub</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">group</span>
                <span class="n">project</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">project</span>
            <span class="c1"># qiskit-ibm-provider style</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="s2">&quot;_hgps&quot;</span><span class="p">):</span>
                <span class="n">hub</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">project</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">_hgps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">hub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">hub</span> <span class="ow">or</span> <span class="n">hub</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">group</span> <span class="ow">or</span> <span class="n">group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">project</span> <span class="ow">or</span> <span class="n">project</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_clear_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete all currently stored analysis results and figures&quot;&quot;&quot;</span>
        <span class="c1"># Schedule existing analysis results for deletion next save call</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_analysis_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="c1"># Schedule existing figures for deletion next save call</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">service</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IBMExperimentService</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the database service.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Service that can be used to access this experiment in a database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span>

    <span class="nd">@service</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">IBMExperimentService</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the service to be used for storing experiment data</span>

<span class="sd">        Args:</span>
<span class="sd">            service: Service to be used.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ExperimentDataError: If an experiment service is already being used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_service</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auto_save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return current auto-save option.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Whether changes will be automatically saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_save</span>

    <span class="nd">@auto_save</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">auto_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_val</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set auto save preference.</span>

<span class="sd">        Args:</span>
<span class="sd">            save_val: Whether to do auto-save.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">save_val</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_save</span> <span class="o">=</span> <span class="n">save_val</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># Setting private variable directly to avoid duplicate save. This</span>
            <span class="c1"># can be removed when we start tracking changes.</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_auto_save</span> <span class="o">=</span> <span class="n">save_val</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_data</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">auto_save</span> <span class="o">=</span> <span class="n">save_val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the class name and version.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;_source&quot;</span><span class="p">]</span>

    <span class="c1"># Data addition and deletion</span>

<div class="viewcode-block" id="ExperimentData.add_data"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.add_data.html#qiskit_experiments.framework.ExperimentData.add_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Result</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Result</span><span class="p">],</span> <span class="n">Job</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">],</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add experiment data.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Experiment data to add. Several types are accepted for convenience:</span>

<span class="sd">                * Result: Add data from this ``Result`` object.</span>
<span class="sd">                * List[Result]: Add data from the ``Result`` objects.</span>
<span class="sd">                * Dict: Add this data.</span>
<span class="sd">                * List[Dict]: Add this list of data.</span>
<span class="sd">                * Job: (Deprecated) Add data from the job result.</span>
<span class="sd">                * List[Job]: (Deprecated) Add data from the job results.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input data type is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not all analysis has finished running. Adding new data may &quot;</span>
                <span class="s2">&quot;create unexpected analysis results.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span>

        <span class="c1"># Directly add non-job data</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datum</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datum</span><span class="p">,</span> <span class="n">Result</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_result_data</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid data type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExperimentData.add_jobs"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.add_jobs.html#qiskit_experiments.framework.ExperimentData.add_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">add_jobs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">jobs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Job</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]],</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add experiment data.</span>

<span class="sd">        Args:</span>
<span class="sd">            jobs: The Job or list of Jobs to add result data from.</span>
<span class="sd">            timeout: Optional, time in seconds to wait for all jobs to finish</span>
<span class="sd">                     before cancelling them.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input data type is invalid.</span>

<span class="sd">        .. note::</span>
<span class="sd">            If a timeout is specified the :meth:`cancel_jobs` method will be</span>
<span class="sd">            called after timing out to attempt to cancel any unfinished jobs.</span>

<span class="sd">            If you want to wait for jobs without cancelling, use the timeout</span>
<span class="sd">            kwarg of :meth:`block_for_results` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not all analysis has finished running. Adding new jobs may &quot;</span>
                <span class="s2">&quot;create unexpected analysis results.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">Job</span><span class="p">):</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">jobs</span><span class="p">]</span>

        <span class="c1"># Add futures for extracting finished job data</span>
        <span class="n">timeout_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">backend_name</span> <span class="o">=</span> <span class="n">BackendData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">job_backend_name</span> <span class="o">=</span> <span class="n">BackendData</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">backend</span><span class="p">())</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="ow">and</span> <span class="n">backend_name</span> <span class="o">!=</span> <span class="n">job_backend_name</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Adding a job from a backend (</span><span class="si">%s</span><span class="s2">) that is different &quot;</span>
                        <span class="s2">&quot;than the current backend (</span><span class="si">%s</span><span class="s2">). &quot;</span>
                        <span class="s2">&quot;The new backend will be used, but &quot;</span>
                        <span class="s2">&quot;service is not changed if one already exists.&quot;</span><span class="p">,</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">backend</span><span class="p">(),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span>

            <span class="n">jid</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Skipping duplicate job, a job with this ID already exists [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">jid</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
                <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Job future has already been submitted [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_job_future</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">timeout_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>

        <span class="c1"># Add future for cancelling jobs that timeout</span>
        <span class="k">if</span> <span class="n">timeout_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout_running_jobs</span><span class="p">,</span> <span class="n">timeout_ids</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_timeout_running_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function for cancelling jobs after timeout length.</span>

<span class="sd">        This function should be submitted to an executor to run as a future.</span>

<span class="sd">        Args:</span>
<span class="sd">            job_ids: the IDs of jobs to wait for.</span>
<span class="sd">            timeout: The total time to wait for all jobs before cancelling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">futs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span><span class="p">]</span>
        <span class="n">waited</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">futs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># Try to cancel timed-out jobs</span>
        <span class="k">if</span> <span class="n">waited</span><span class="o">.</span><span class="n">not_done</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cancelling running jobs that exceeded add_jobs timeout.&quot;</span><span class="p">)</span>
            <span class="n">done_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">waited</span><span class="o">.</span><span class="n">done</span><span class="p">}</span>
            <span class="n">notdone_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">jid</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">job_ids</span> <span class="k">if</span> <span class="n">jid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done_ids</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cancel_jobs</span><span class="p">(</span><span class="n">notdone_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_job_future</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Submit new _add_job_data job to executor&quot;&quot;&quot;</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Job future has already been submitted [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_job_data</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_job_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for a job to finish and add job result data.</span>

<span class="sd">        Args:</span>
<span class="sd">            job: the Job to wait for and add data from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple (str, bool) of the job id and bool of if the job data was added.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If an error occured when adding job data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jid</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job_result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_result_data</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Job data added [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jid</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="c1"># Handle cancelled jobs</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Job was cancelled before completion [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">jid</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Job data not added for errorred job [Job ID: </span><span class="si">%s</span><span class="s2">]</span><span class="se">\n</span><span class="s2">Error message: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">jid</span><span class="p">,</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">error_message</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">jid</span><span class="p">,</span> <span class="kc">False</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Adding data from job failed [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">())</span>
            <span class="k">raise</span> <span class="n">ex</span>

<div class="viewcode-block" id="ExperimentData.add_analysis_callback"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.add_analysis_callback.html#qiskit_experiments.framework.ExperimentData.add_analysis_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_analysis_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add analysis callback for running after experiment data jobs are finished.</span>

<span class="sd">        This method adds the `callback` function to a queue to be run</span>
<span class="sd">        asynchronously after completion of any running jobs, or immediately</span>
<span class="sd">        if no running jobs. If this method is called multiple times the</span>
<span class="sd">        callback functions will be executed in the order they were</span>
<span class="sd">        added.</span>

<span class="sd">        Args:</span>
<span class="sd">            callback: Callback function invoked when job finishes successfully.</span>
<span class="sd">                      The callback function will be called as</span>
<span class="sd">                      ``callback(expdata, **kwargs)`` where `expdata` is this</span>
<span class="sd">                      ``DbExperimentData`` object, and `kwargs` are any additional</span>
<span class="sd">                      keywork arguments passed to this method.</span>
<span class="sd">            **kwargs: Keyword arguments to be passed to the callback function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">lock</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Create callback dataclass</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisCallback</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">callback</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">callback_id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Futures to wait for</span>
            <span class="n">futs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">wait_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_futures</span><span class="p">,</span> <span class="n">futs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;jobs and analysis&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Create a future to monitor event for calls to cancel_analysis</span>
            <span class="k">def</span> <span class="nf">_monitor_cancel</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">cancel_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_monitor_cancel</span><span class="p">)</span>

            <span class="c1"># Add run analysis future</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_analysis_callback</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">wait_future</span><span class="p">,</span> <span class="n">cancel_future</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_analysis_callback</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">callback_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">wait_future</span><span class="p">:</span> <span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">,</span>
        <span class="n">cancel_future</span><span class="p">:</span> <span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run an analysis callback after specified futures have finished.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No analysis callback with id </span><span class="si">{</span><span class="n">callback_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Monitor jobs and cancellation event to see if callback should be run</span>
        <span class="c1"># or cancelled</span>
        <span class="c1"># Future which returns if either all jobs finish, or cancel event is set</span>
        <span class="n">waited</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">wait_future</span><span class="p">,</span> <span class="n">cancel_future</span><span class="p">],</span> <span class="n">return_when</span><span class="o">=</span><span class="s2">&quot;FIRST_COMPLETED&quot;</span><span class="p">)</span>
        <span class="n">cancel</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">waited</span><span class="o">.</span><span class="n">done</span><span class="p">)</span>

        <span class="c1"># Ensure monitor event is set so monitor future can terminate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">callback_id</span><span class="p">]</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="c1"># If not ready cancel the callback before running</span>
        <span class="k">if</span> <span class="n">cancel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">callback_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">CANCELLED</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Cancelled analysis callback [Experiment ID: </span><span class="si">%s</span><span class="s2">][Analysis Callback ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="n">callback_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">callback_id</span><span class="p">,</span> <span class="kc">False</span>

        <span class="c1"># Run callback function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">callback_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">RUNNING</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Running analysis callback &#39;</span><span class="si">%s</span><span class="s2">&#39; [Experiment ID: </span><span class="si">%s</span><span class="s2">][Analysis Callback ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">callback_id</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="n">callback_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">callback_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">DONE</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Analysis callback finished [Experiment ID: </span><span class="si">%s</span><span class="s2">][Analysis Callback ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="n">callback_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">callback_id</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">callback_id</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">ERROR</span>
            <span class="n">tb_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">))</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Analysis callback failed [Experiment ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[Analysis Callback ID: </span><span class="si">{</span><span class="n">callback_id</span><span class="si">}</span><span class="s2">]:</span><span class="se">\n</span><span class="si">{</span><span class="n">tb_text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">[</span><span class="n">callback_id</span><span class="p">]</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">error_msg</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">callback_id</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_add_result_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Result</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add data from a Result object</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Result object containing data to be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Lock data while adding all result data</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">results</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;job_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">job_id</span>
                <span class="k">if</span> <span class="s2">&quot;counts&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="c1"># Format to Counts object rather than hex dict</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get_counts</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">expr_result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr_result</span><span class="p">,</span> <span class="s2">&quot;header&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr_result</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr_result</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">metadata</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;shots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr_result</span><span class="o">.</span><span class="n">shots</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meas_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr_result</span><span class="o">.</span><span class="n">meas_level</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expr_result</span><span class="p">,</span> <span class="s2">&quot;meas_return&quot;</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meas_return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr_result</span><span class="o">.</span><span class="n">meas_return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_retrieve_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve job data if missing experiment data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Get job results if missing experiment data.</span>
        <span class="n">retrieved_jobs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving job from backend </span><span class="si">%s</span><span class="s2"> [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">retrieve_job</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span>
                    <span class="n">retrieved_jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to retrieve data from job on backend </span><span class="si">%s</span><span class="s2"> [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span>
                        <span class="n">jid</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="c1"># Add retrieved job objects to stored jobs and extract data</span>
        <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">retrieved_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="ow">in</span> <span class="n">JOB_FINAL_STATES</span><span class="p">:</span>
                <span class="c1"># Add job results synchronously</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_job_data</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add job results asynchronously</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_job_future</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

<div class="viewcode-block" id="ExperimentData.data"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.data.html#qiskit_experiments.framework.ExperimentData.data">[docs]</a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the experiment data at the specified index.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: Index of the data to be returned.</span>
<span class="sd">                Several types are accepted for convenience:</span>

<span class="sd">                    * None: Return all experiment data.</span>
<span class="sd">                    * int: Specific index of the data.</span>
<span class="sd">                    * slice: A list slice of data indexes.</span>
<span class="sd">                    * str: ID of the job that produced the data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Experiment data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input `index` has an invalid type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;job_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid index type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExperimentData.add_figures"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.add_figures.html#qiskit_experiments.framework.ExperimentData.add_figures">[docs]</a>    <span class="nd">@do_auto_save</span>
    <span class="k">def</span> <span class="nf">add_figures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figures</span><span class="p">,</span>
        <span class="n">figure_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_figure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the experiment figure.</span>

<span class="sd">        Args:</span>
<span class="sd">            figures (str or bytes or pyplot.Figure or list): Paths of the figure</span>
<span class="sd">                files or figure data.</span>
<span class="sd">            figure_names (str or list): Names of the figures. If ``None``, use the figure file</span>
<span class="sd">                names, if given, or a generated name. If `figures` is a list, then</span>
<span class="sd">                `figure_names` must also be a list of the same length or ``None``.</span>
<span class="sd">            overwrite (bool): Whether to overwrite the figure if one already exists with</span>
<span class="sd">                the same name.</span>
<span class="sd">            save_figure (bool): Whether to save the figure in the database. If ``None``,</span>
<span class="sd">                the ``auto-save`` attribute is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str or list:</span>
<span class="sd">                Figure names.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ExperimentEntryExists: If the figure with the same name already exists,</span>
<span class="sd">                and `overwrite=True` is not specified.</span>
<span class="sd">            ValueError: If an input parameter has an invalid value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">figure_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">figure_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">figure_names</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figures</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">figures</span> <span class="o">=</span> <span class="p">[</span><span class="n">figures</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">figure_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">figure_names</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The parameter figure_names must be None or a list of &quot;</span>
                <span class="s2">&quot;the same size as the parameter figures.&quot;</span>
            <span class="p">)</span>

        <span class="n">added_figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">figure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figures</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">figure_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">fig_name</span> <span class="o">=</span> <span class="n">figure</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig_name</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_type</span><span class="si">}</span><span class="s2">_&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Fig-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="p">)</span><span class="si">}</span><span class="s2">_&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Exp-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">.svg&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig_name</span> <span class="o">=</span> <span class="n">figure_names</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">fig_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.svg&quot;</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File name </span><span class="si">%s</span><span class="s2"> does not have an SVG extension. A &#39;.svg&#39; is added.&quot;</span><span class="p">)</span>
                <span class="n">fig_name</span> <span class="o">+=</span> <span class="s2">&quot;.svg&quot;</span>

            <span class="n">existing_figure</span> <span class="o">=</span> <span class="n">fig_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span>
            <span class="k">if</span> <span class="n">existing_figure</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExperimentEntryExists</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;A figure with the name </span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2"> for this experiment &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;already exists. Specify overwrite=True if you &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;want to overwrite it.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># figure_data = None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">figure</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="c1"># check whether the figure is already wrapped, meaning it came from a sub-experiment</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">FigureData</span><span class="p">):</span>
                <span class="n">figure_data</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">new_name</span><span class="o">=</span><span class="n">fig_name</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">figure_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;qubits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;physical_qubits&quot;</span><span class="p">)}</span>
                <span class="n">figure_data</span> <span class="o">=</span> <span class="n">FigureData</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">fig_name</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">figure_metadata</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="p">[</span><span class="n">fig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">figure_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">figure_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_name</span><span class="p">)</span>

            <span class="n">save</span> <span class="o">=</span> <span class="n">save_figure</span> <span class="k">if</span> <span class="n">save_figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span>
            <span class="k">if</span> <span class="n">save</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">Figure</span><span class="p">):</span>
                    <span class="n">figure</span> <span class="o">=</span> <span class="n">plot_to_svg_bytes</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">create_or_update_figure</span><span class="p">(</span>
                    <span class="n">experiment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                    <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span>
                    <span class="n">figure_name</span><span class="o">=</span><span class="n">fig_name</span><span class="p">,</span>
                    <span class="n">create</span><span class="o">=</span><span class="ow">not</span> <span class="n">existing_figure</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">added_figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">added_figs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">added_figs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">added_figs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="ExperimentData.delete_figure"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.delete_figure.html#qiskit_experiments.framework.ExperimentData.delete_figure">[docs]</a>    <span class="nd">@do_auto_save</span>
    <span class="k">def</span> <span class="nf">delete_figure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figure_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the experiment figure.</span>

<span class="sd">        Args:</span>
<span class="sd">            figure_key: Name or index of the figure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Figure name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ExperimentEntryNotFound: If the figure is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">figure_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">figure_key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">figure_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExperimentEntryNotFound</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure </span><span class="si">{</span><span class="n">figure_key</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="p">[</span><span class="n">figure_key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">service_exception_to_warning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">delete_figure</span><span class="p">(</span><span class="n">experiment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">figure_name</span><span class="o">=</span><span class="n">figure_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_figures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">figure_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figure_key</span></div>

<div class="viewcode-block" id="ExperimentData.figure"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.figure.html#qiskit_experiments.framework.ExperimentData.figure">[docs]</a>    <span class="k">def</span> <span class="nf">figure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figure_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">FigureData</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the specified experiment figure.</span>

<span class="sd">        Args:</span>
<span class="sd">            figure_key: Name or index of the figure.</span>
<span class="sd">            file_name: Name of the local file to save the figure to. If ``None``,</span>
<span class="sd">                the content of the figure is returned instead.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The size of the figure if `file_name` is specified. Otherwise the</span>
<span class="sd">            content of the figure as a `FigureData` object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ExperimentEntryNotFound: If the figure cannot be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">figure_key</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">figure_key</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="n">ExperimentEntryNotFound</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure </span><span class="si">{</span><span class="n">figure_key</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
            <span class="n">figure_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">figure_key</span><span class="p">]</span>

        <span class="n">figure_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">figure_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">figure_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">:</span>
            <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">experiment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">figure_name</span><span class="o">=</span><span class="n">figure_key</span><span class="p">)</span>
            <span class="n">figure_data</span> <span class="o">=</span> <span class="n">FigureData</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">figure_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="p">[</span><span class="n">figure_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">figure_data</span>

        <span class="k">if</span> <span class="n">figure_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExperimentEntryNotFound</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure </span><span class="si">{</span><span class="n">figure_key</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">num_bytes</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">figure_data</span><span class="o">.</span><span class="n">figure</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">num_bytes</span>
        <span class="k">return</span> <span class="n">figure_data</span></div>

<div class="viewcode-block" id="ExperimentData.add_analysis_results"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.add_analysis_results.html#qiskit_experiments.framework.ExperimentData.add_analysis_results">[docs]</a>    <span class="nd">@do_auto_save</span>
    <span class="k">def</span> <span class="nf">add_analysis_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">results</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnalysisResult</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">AnalysisResult</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the analysis result.</span>

<span class="sd">        Args:</span>
<span class="sd">            results: Analysis results to be saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">result_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">ExperimentDataError</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span>
                <span class="n">result</span><span class="o">.</span><span class="n">auto_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="ExperimentData.delete_analysis_result"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.delete_analysis_result.html#qiskit_experiments.framework.ExperimentData.delete_analysis_result">[docs]</a>    <span class="nd">@do_auto_save</span>
    <span class="k">def</span> <span class="nf">delete_analysis_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result_key</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the analysis result.</span>

<span class="sd">        Args:</span>
<span class="sd">            result_key: ID or index of the analysis result to be deleted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Analysis result ID.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ExperimentEntryNotFound: If analysis result not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">result_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">result_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Retrieve from DB if needed.</span>
            <span class="n">result_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_results</span><span class="p">(</span><span class="n">result_key</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">result_id</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">[</span><span class="n">result_key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_analysis_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">service_exception_to_warning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">delete_analysis_result</span><span class="p">(</span><span class="n">result_id</span><span class="o">=</span><span class="n">result_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_analysis_results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">result_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_key</span></div>

    <span class="k">def</span> <span class="nf">_retrieve_analysis_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve service analysis results.</span>

<span class="sd">        Args:</span>
<span class="sd">            refresh: Retrieve the latest analysis results from the server, if</span>
<span class="sd">                an experiment service is available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get job results if missing experiment data.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span> <span class="ow">or</span> <span class="n">refresh</span><span class="p">):</span>
            <span class="n">retrieved_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">analysis_results</span><span class="p">(</span>
                <span class="n">experiment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_decoder</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">retrieved_results</span><span class="p">:</span>
                <span class="n">result_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">result_id</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">[</span><span class="n">result_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">AnalysisResult</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">[</span><span class="n">result_id</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">[</span><span class="n">result_id</span><span class="p">]</span><span class="o">.</span><span class="n">_created_in_db</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="ExperimentData.analysis_results"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.analysis_results.html#qiskit_experiments.framework.ExperimentData.analysis_results">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">block</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AnalysisResult</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">AnalysisResult</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return analysis results associated with this experiment.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: Index of the analysis result to be returned.</span>
<span class="sd">                Several types are accepted for convenience:</span>

<span class="sd">                    * None: Return all analysis results.</span>
<span class="sd">                    * int: Specific index of the analysis results.</span>
<span class="sd">                    * slice: A list slice of indexes.</span>
<span class="sd">                    * str: ID or name of the analysis result.</span>
<span class="sd">            refresh: Retrieve the latest analysis results from the server, if</span>
<span class="sd">                an experiment service is available.</span>
<span class="sd">            block: If True block for any analysis callbacks to finish running.</span>
<span class="sd">            timeout: max time in seconds to wait for analysis callbacks to finish running.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Analysis results for this experiment.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the input `index` has an invalid type.</span>
<span class="sd">            ExperimentEntryNotFound: If the entry cannot be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_futures</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_analysis_results</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_make_not_found_message</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Helper to make error message for index not found&quot;&quot;&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Analysis result </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">]</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="n">ExperimentEntryNotFound</span><span class="p">(</span><span class="n">_make_not_found_message</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExperimentEntryNotFound</span><span class="p">(</span><span class="n">_make_not_found_message</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Check by result ID</span>
            <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="c1"># Check by name</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">index</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExperimentEntryNotFound</span><span class="p">(</span><span class="n">_make_not_found_message</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">filtered</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid index type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

    <span class="c1"># Save and load from the database</span>

<div class="viewcode-block" id="ExperimentData.save_metadata"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.save_metadata.html#qiskit_experiments.framework.ExperimentData.save_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">save_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save this experiments metadata to a database service.</span>

<span class="sd">        .. note::</span>
<span class="sd">            This method does not save analysis results nor figures.</span>
<span class="sd">            Use :meth:`save` for general saving of all experiment data.</span>

<span class="sd">            See :meth:`qiskit.providers.experiment.IBMExperimentService.create_experiment`</span>
<span class="sd">            for fields that are saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_experiment_metadata</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_data</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">save_metadata</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_save_experiment_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suppress_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save this experiments metadata to a database service.</span>
<span class="sd">        Args:</span>
<span class="sd">            suppress_errors: should the method catch exceptions (true) or</span>
<span class="sd">            pass them on, potentially aborting the experiemnt (false)</span>
<span class="sd">        Raises:</span>
<span class="sd">            QiskitError: If the save to the database failed</span>
<span class="sd">        .. note::</span>
<span class="sd">            This method does not save analysis results nor figures.</span>
<span class="sd">            Use :meth:`save` for general saving of all experiment data.</span>

<span class="sd">            See :meth:`qiskit.providers.experiment.IBMExperimentService.create_experiment`</span>
<span class="sd">            for fields that are saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Experiment cannot be saved because no experiment service is available. &quot;</span>
                <span class="s2">&quot;An experiment service is available, for example, &quot;</span>
                <span class="s2">&quot;when using an IBM Quantum backend.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle_metadata_separately</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_too_large</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">handle_metadata_separately</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">metadata</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">create_or_update_experiment</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="p">,</span> <span class="n">json_encoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_encoder</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_in_db</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_created_in_db</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">handle_metadata_separately</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">file_upload</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_filename</span><span class="p">,</span> <span class="n">metadata</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="c1"># Don&#39;t automatically fail the experiment just because its data cannot be saved.</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to save the experiment data: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_errors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QiskitError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experiment data save failed</span><span class="se">\n</span><span class="s2">Error Message:</span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="k">def</span> <span class="nf">_metadata_too_large</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determines whether the metadata should be stored in a separate file&quot;&quot;&quot;</span>
        <span class="c1"># currently the entire POST JSON request body is limited by default to 100kb</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span>

<div class="viewcode-block" id="ExperimentData.save"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.save.html#qiskit_experiments.framework.ExperimentData.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suppress_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the experiment data to a database service.</span>

<span class="sd">        Args:</span>
<span class="sd">            suppress_errors: should the method catch exceptions (true) or</span>
<span class="sd">            pass them on, potentially aborting the experiemnt (false)</span>
<span class="sd">        .. note::</span>
<span class="sd">            This saves the experiment metadata, all analysis results, and all</span>
<span class="sd">            figures. Depending on the number of figures and analysis results this</span>
<span class="sd">            operation could take a while.</span>

<span class="sd">            To only update a previously saved experiments metadata (eg for</span>
<span class="sd">            additional tags or notes) use :meth:`save_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO - track changes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Experiment cannot be saved because no experiment service is available. &quot;</span>
                <span class="s2">&quot;An experiment service is available, for example, &quot;</span>
                <span class="s2">&quot;when using an IBM Quantum backend.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_experiment_metadata</span><span class="p">(</span><span class="n">suppress_errors</span><span class="o">=</span><span class="n">suppress_errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_in_db</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not save experiment metadata to DB, aborting experiment save&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">suppress_errors</span><span class="o">=</span><span class="n">suppress_errors</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_analysis_results</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">service_exception_to_warning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">delete_analysis_result</span><span class="p">(</span><span class="n">result_id</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_analysis_results</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">figure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># currently only the figure and its name are stored in the database</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">FigureData</span><span class="p">):</span>
                    <span class="n">figure</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">figure</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Figure metadata is currently not saved to the database&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">Figure</span><span class="p">):</span>
                    <span class="n">figure</span> <span class="o">=</span> <span class="n">plot_to_svg_bytes</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">create_or_update_figure</span><span class="p">(</span>
                    <span class="n">experiment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">figure_name</span><span class="o">=</span><span class="n">name</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_figures</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">service_exception_to_warning</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">delete_figure</span><span class="p">(</span><span class="n">experiment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">figure_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_figures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">local</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;You can view the experiment online at &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;https://quantum-computing.ibm.com/experiments/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># handle children, but without additional prints</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">original_verbose</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">verbose</span>
            <span class="n">data</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">data</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">original_verbose</span></div>

<div class="viewcode-block" id="ExperimentData.jobs"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.jobs.html#qiskit_experiments.framework.ExperimentData.jobs">[docs]</a>    <span class="k">def</span> <span class="nf">jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of jobs for the experiment&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

<div class="viewcode-block" id="ExperimentData.cancel_jobs"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.cancel_jobs.html#qiskit_experiments.framework.ExperimentData.cancel_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel any running jobs.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids: Job(s) to cancel. If None all non-finished jobs will be cancelled.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the specified jobs were successfully cancelled</span>
<span class="sd">            otherwise false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">all_cancelled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">ids</span> <span class="ow">and</span> <span class="n">jid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="c1"># Skip cancelling this callback</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">job</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">JOB_FINAL_STATES</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cancelled job [Job ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">jid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                        <span class="n">all_cancelled</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to cancel job [Job ID: </span><span class="si">%s</span><span class="s2">]:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                        <span class="k">continue</span>

                <span class="c1"># Remove done or cancelled job futures</span>
                <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">all_cancelled</span></div>

<div class="viewcode-block" id="ExperimentData.cancel_analysis"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.cancel_analysis.html#qiskit_experiments.framework.ExperimentData.cancel_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel any queued analysis callbacks.</span>

<span class="sd">        .. note::</span>
<span class="sd">            A currently running analysis callback cannot be cancelled.</span>

<span class="sd">        Args:</span>
<span class="sd">            ids: Analysis callback(s) to cancel. If None all non-finished</span>
<span class="sd">                 analysis will be cancelled.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the specified analysis callbacks were successfully</span>
<span class="sd">            cancelled otherwise false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>

        <span class="c1"># Lock analysis futures so we can&#39;t add more while trying to cancel</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">all_cancelled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">not_running</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">ids</span> <span class="ow">and</span> <span class="n">cid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="c1"># Skip cancelling this callback</span>
                    <span class="k">continue</span>

                <span class="c1"># Set event to cancel callback</span>
                <span class="n">callback</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                <span class="c1"># Check for running callback that can&#39;t be cancelled</span>
                <span class="k">if</span> <span class="n">callback</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
                    <span class="n">all_cancelled</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to cancel running analysis callback [Experiment ID: </span><span class="si">%s</span><span class="s2">]&quot;</span>
                        <span class="s2">&quot;[Analysis Callback ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                        <span class="n">cid</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">not_running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>

            <span class="c1"># Wait for completion of other futures cancelled via event.set</span>
            <span class="n">waited</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">not_running</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Get futures that didn&#39;t raise exception</span>
            <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">waited</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">exception</span><span class="p">():</span>
                    <span class="n">cid</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">all_cancelled</span></div>

<div class="viewcode-block" id="ExperimentData.cancel"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.cancel.html#qiskit_experiments.framework.ExperimentData.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to cancel any running jobs and queued analysis callbacks.</span>

<span class="sd">        .. note::</span>
<span class="sd">            A running analysis callback cannot be cancelled.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if all jobs and analysis are successfully cancelled, otherwise false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Cancel analysis first since it is queued on jobs, then cancel jobs</span>
        <span class="c1"># otherwise there can be a race issue when analysis starts running</span>
        <span class="c1"># as soon as jobs are cancelled</span>
        <span class="n">analysis_cancelled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_analysis</span><span class="p">()</span>
        <span class="n">jobs_cancelled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_jobs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">analysis_cancelled</span> <span class="ow">and</span> <span class="n">jobs_cancelled</span></div>

<div class="viewcode-block" id="ExperimentData.block_for_results"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.block_for_results.html#qiskit_experiments.framework.ExperimentData.block_for_results">[docs]</a>    <span class="k">def</span> <span class="nf">block_for_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExperimentData&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block until all pending jobs and analysis callbacks finish.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout: Timeout in seconds for waiting for results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The experiment data with finished jobs and post-processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">lock</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># Lock threads to get all current job and analysis futures</span>
            <span class="c1"># at the time of function call and then release the lock</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">job_futs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">analysis_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">analysis_futs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="c1"># Wait for futures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_futures</span><span class="p">(</span><span class="n">job_futs</span> <span class="o">+</span> <span class="n">analysis_futs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;jobs and analysis&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># Clean up done job futures</span>
        <span class="n">num_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">fut</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">job_futs</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">exception</span><span class="p">())</span> <span class="ow">or</span> <span class="n">fut</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">jid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span>
                    <span class="n">num_jobs</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Clean up done analysis futures</span>
        <span class="n">num_analysis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">analysis_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">fut</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">analysis_ids</span><span class="p">,</span> <span class="n">analysis_futs</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">exception</span><span class="p">())</span> <span class="ow">or</span> <span class="n">fut</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
                    <span class="n">num_analysis</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># Check if more futures got added while this function was running</span>
        <span class="c1"># and block recursively. This could happen if an analysis callback</span>
        <span class="c1"># spawns another callback or creates more jobs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_jobs</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_analysis</span><span class="p">:</span>
            <span class="n">time_taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">-</span> <span class="n">time_taken</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_for_results</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_wait_for_futures</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">futs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;futures&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait for jobs to finish running.</span>

<span class="sd">        Args:</span>
<span class="sd">            futs: Job or analysis futures to wait for.</span>
<span class="sd">            name: type name for future for logger messages.</span>
<span class="sd">            timeout: The length of time to wait for all jobs</span>
<span class="sd">                     before returning False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if all jobs finished. False if timeout time was reached</span>
<span class="sd">            or any jobs were cancelled or had an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">waited</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">futs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Log futures still running after timeout</span>
        <span class="k">if</span> <span class="n">waited</span><span class="o">.</span><span class="n">not_done</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Waiting for </span><span class="si">%s</span><span class="s2"> timed out before completion [Experiment ID: </span><span class="si">%s</span><span class="s2">].&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check for futures that were cancelled or errorred</span>
        <span class="n">excepts</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="n">waited</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">excepts</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">fut</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> was cancelled before completion [Experiment ID: </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># The job/analysis did not succeed, and the failure reflects in the second</span>
                <span class="c1"># returned value of _add_job_data/_run_analysis_callback. See details in Issue #866.</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">excepts</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> raised exceptions [Experiment ID: </span><span class="si">%s</span><span class="s2">]:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">excepts</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="ExperimentData.status"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.status.html#qiskit_experiments.framework.ExperimentData.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExperimentStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the experiment status.</span>

<span class="sd">        Possible return values for :class:`.ExperimentStatus` are</span>

<span class="sd">        * :attr:`~.ExperimentStatus.EMPTY` - experiment data is empty</span>
<span class="sd">        * :attr:`~.ExperimentStatus.INITIALIZING` - experiment jobs are being initialized</span>
<span class="sd">        * :attr:`~.ExperimentStatus.QUEUED` - experiment jobs are queued</span>
<span class="sd">        * :attr:`~.ExperimentStatus.RUNNING` - experiment jobs is actively running</span>
<span class="sd">        * :attr:`~.ExperimentStatus.CANCELLED` - experiment jobs or analysis has been cancelled</span>
<span class="sd">        * :attr:`~.ExperimentStatus.POST_PROCESSING` - experiment analysis is actively running</span>
<span class="sd">        * :attr:`~.ExperimentStatus.DONE` - experiment jobs and analysis have successfully run</span>
<span class="sd">        * :attr:`~.ExperimentStatus.ERROR` - experiment jobs or analysis incurred an error</span>

<span class="sd">        .. note::</span>

<span class="sd">            If an experiment has status :attr:`~.ExperimentStatus.ERROR`</span>
<span class="sd">            there may still be pending or running jobs. In these cases it</span>
<span class="sd">            may be beneficial to call :meth:`cancel_jobs` to terminate these</span>
<span class="sd">            remaining jobs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The experiment status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">container</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">EMPTY</span>

        <span class="c1"># Return job status is job is not DONE</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">JobStatus</span><span class="o">.</span><span class="n">INITIALIZING</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">INITIALIZING</span><span class="p">,</span>
                <span class="n">JobStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
                <span class="n">JobStatus</span><span class="o">.</span><span class="n">VALIDATING</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">VALIDATING</span><span class="p">,</span>
                <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
                <span class="n">JobStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">,</span>
                <span class="n">JobStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Return analysis status if Done, cancelled or error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">DONE</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">DONE</span><span class="p">,</span>
                <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">,</span>
                <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_status</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ExperimentStatus</span><span class="o">.</span><span class="n">POST_PROCESSING</span></div>

<div class="viewcode-block" id="ExperimentData.job_status"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.job_status.html#qiskit_experiments.framework.ExperimentData.job_status">[docs]</a>    <span class="k">def</span> <span class="nf">job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JobStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the experiment job execution status.</span>

<span class="sd">        Possible return values for :class:`qiskit.providers.jobstatus.JobStatus` are</span>

<span class="sd">        * ``ERROR`` - if any job incurred an error</span>
<span class="sd">        * ``CANCELLED`` - if any job is cancelled.</span>
<span class="sd">        * ``RUNNING`` - if any job is still running.</span>
<span class="sd">        * ``QUEUED`` - if any job is queued.</span>
<span class="sd">        * ``VALIDATING`` - if any job is being validated.</span>
<span class="sd">        * ``INITIALIZING`` - if any job is being initialized.</span>
<span class="sd">        * ``DONE`` - if all jobs are finished.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If an experiment has status ``ERROR`` or ``CANCELLED`` there may still be</span>
<span class="sd">            pending or running jobs. In these cases it may be beneficial to call</span>
<span class="sd">            :meth:`cancel_jobs` to terminate these remaining jobs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The job execution status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>

            <span class="c1"># No jobs present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">DONE</span>

            <span class="n">statuses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                    <span class="n">statuses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">())</span>

        <span class="c1"># If any jobs are in non-DONE state return that state</span>
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">JobStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">JobStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">,</span>
            <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
            <span class="n">JobStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
            <span class="n">JobStatus</span><span class="o">.</span><span class="n">VALIDATING</span><span class="p">,</span>
            <span class="n">JobStatus</span><span class="o">.</span><span class="n">INITIALIZING</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">statuses</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">stat</span>

        <span class="k">return</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">DONE</span></div>

<div class="viewcode-block" id="ExperimentData.analysis_status"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.analysis_status.html#qiskit_experiments.framework.ExperimentData.analysis_status">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnalysisStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the data analysis post-processing status.</span>

<span class="sd">        Possible return values for :class:`.AnalysisStatus` are</span>

<span class="sd">        * :attr:`~.AnalysisStatus.ERROR` - if any analysis callback incurred an error</span>
<span class="sd">        * :attr:`~.AnalysisStatus.CANCELLED` - if any analysis callback is cancelled.</span>
<span class="sd">        * :attr:`~.AnalysisStatus.RUNNING` - if any analysis callback is actively running.</span>
<span class="sd">        * :attr:`~.AnalysisStatus.QUEUED` - if any analysis callback is queued.</span>
<span class="sd">        * :attr:`~.AnalysisStatus.DONE` - if all analysis callbacks have successfully run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Then analysis status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">statuses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">,</span>
            <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
            <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">statuses</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">stat</span>

        <span class="k">return</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">DONE</span></div>

<div class="viewcode-block" id="ExperimentData.job_errors"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.job_errors.html#qiskit_experiments.framework.ExperimentData.job_errors">[docs]</a>    <span class="k">def</span> <span class="nf">job_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return any errors encountered in job execution.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get any job errors</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">()</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">):</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">error_message</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Job ID: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">()</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get any job futures errors:</span>
        <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">fut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fut</span> <span class="ow">and</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="n">fut</span><span class="o">.</span><span class="n">exception</span><span class="p">():</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[Job ID: </span><span class="si">{</span><span class="n">jid</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExperimentData.analysis_errors"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.analysis_errors.html#qiskit_experiments.framework.ExperimentData.analysis_errors">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return any errors encountered during analysis callbacks.&quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get any callback errors</span>
        <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">callback</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[Analysis Callback ID: </span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">callback</span><span class="o">.</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExperimentData.errors"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.errors.html#qiskit_experiments.framework.ExperimentData.errors">[docs]</a>    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return errors encountered during job and analysis execution.</span>

<span class="sd">        .. note::</span>
<span class="sd">            To display only job or analysis errors use the</span>
<span class="sd">            :meth:`job_errors` or :meth:`analysis_errors` methods.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Experiment errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_errors</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_errors</span><span class="p">()</span></div>

    <span class="c1"># Children handling</span>

<div class="viewcode-block" id="ExperimentData.add_child_data"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.add_child_data.html#qiskit_experiments.framework.ExperimentData.add_child_data">[docs]</a>    <span class="k">def</span> <span class="nf">add_child_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">experiment_data</span><span class="p">:</span> <span class="n">ExperimentData</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add child experiment data to the current experiment data&quot;&quot;&quot;</span>
        <span class="n">experiment_data</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="p">[</span><span class="n">experiment_data</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;child_data_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="ExperimentData.child_data"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.child_data.html#qiskit_experiments.framework.ExperimentData.child_data">[docs]</a>    <span class="k">def</span> <span class="nf">child_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ExperimentData</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ExperimentData</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return child experiment data.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: Index of the child experiment data to be returned.</span>
<span class="sd">                Several types are accepted for convenience:</span>

<span class="sd">                    * None: Return all child data.</span>
<span class="sd">                    * int: Specific index of the child data.</span>
<span class="sd">                    * slice: A list slice of indexes.</span>
<span class="sd">                    * str: experiment ID of the child data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The requested single or list of child experiment data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            QiskitError: If the index or ID of the child experiment data</span>
<span class="sd">                         cannot be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">QiskitError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid index type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExperimentData.load"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.load.html#qiskit_experiments.framework.ExperimentData.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">IBMExperimentService</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExperimentData&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a saved experiment data from a database service.</span>

<span class="sd">        Args:</span>
<span class="sd">            experiment_id: Experiment ID.</span>
<span class="sd">            service: the database service.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The loaded experiment data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">experiment</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">json_decoder</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_json_decoder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">service</span><span class="o">.</span><span class="n">experiment_has_file</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_metadata_filename</span><span class="p">):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">file_download</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_metadata_filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">expdata</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">,</span> <span class="n">db_data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Retrieve data and analysis results</span>
        <span class="c1"># Maybe this isn&#39;t necessary but the repr of the class should</span>
        <span class="c1"># be updated to show correct number of results including remote ones</span>
        <span class="n">expdata</span><span class="o">.</span><span class="n">_retrieve_data</span><span class="p">()</span>
        <span class="n">expdata</span><span class="o">.</span><span class="n">_retrieve_analysis_results</span><span class="p">()</span>

        <span class="c1"># mark it as existing in the DB</span>
        <span class="n">expdata</span><span class="o">.</span><span class="n">_created_in_db</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">child_data_ids</span> <span class="o">=</span> <span class="n">expdata</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;child_data_ids&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">child_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">ExperimentData</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">child_id</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span> <span class="k">for</span> <span class="n">child_id</span> <span class="ow">in</span> <span class="n">child_data_ids</span><span class="p">]</span>
        <span class="n">expdata</span><span class="o">.</span><span class="n">_set_child_data</span><span class="p">(</span><span class="n">child_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">expdata</span></div>

<div class="viewcode-block" id="ExperimentData.copy"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.copy.html#qiskit_experiments.framework.ExperimentData.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ExperimentData&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of the experiment data with a new experiment ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            copy_results: If True copy the analysis results and figures</span>
<span class="sd">                          into the returned container, along with the</span>
<span class="sd">                          experiment data and metadata. If False only copy</span>
<span class="sd">                          the experiment data and metadata.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the experiment data object with the same data</span>
<span class="sd">            but different IDs.</span>

<span class="sd">        .. note:</span>
<span class="sd">            If analysis results and figures are copied they will also have</span>
<span class="sd">            new result IDs and figure names generated for the copies.</span>

<span class="sd">            This method can not be called from an analysis callback. It waits</span>
<span class="sd">            for analysis callbacks to complete before copying analysis results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_instance</span> <span class="o">=</span> <span class="n">ExperimentData</span><span class="p">(</span>
            <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span>
            <span class="n">service</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="p">,</span>
            <span class="n">parent_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span>
            <span class="n">job_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="p">,</span>
            <span class="n">child_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">new_instance</span><span class="o">.</span><span class="n">_db_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_instance</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">experiment_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># different id for copied experiment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">_experiment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">_experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Copying experiment data [Experiment ID: </span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Copy basic properties and metadata</span>

        <span class="n">new_instance</span><span class="o">.</span><span class="n">_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">copy_object</span><span class="p">()</span>
        <span class="n">new_instance</span><span class="o">.</span><span class="n">_auto_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_save</span>
        <span class="n">new_instance</span><span class="o">.</span><span class="n">_extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_data</span>

        <span class="c1"># Copy circuit result data and jobs</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>  <span class="c1"># Hold the lock so no new data can be added.</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">_result_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="o">.</span><span class="n">copy_object</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">jid</span><span class="p">,</span> <span class="n">fut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">new_instance</span><span class="o">.</span><span class="n">_add_job_future</span><span class="p">(</span><span class="n">new_instance</span><span class="o">.</span><span class="n">_jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">])</span>

        <span class="c1"># If not copying results return the object</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">copy_results</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_instance</span>

        <span class="c1"># Copy results and figures.</span>
        <span class="c1"># This requires analysis callbacks to finish</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_futures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;analysis&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">_analysis_results</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">add_analysis_results</span><span class="p">([</span><span class="n">result</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_results</span><span class="p">()])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">_figures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
            <span class="n">new_instance</span><span class="o">.</span><span class="n">add_figures</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># Recursively copy child data</span>
        <span class="n">child_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">copy_results</span><span class="o">=</span><span class="n">copy_results</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_data</span><span class="p">()]</span>
        <span class="n">new_instance</span><span class="o">.</span><span class="n">_set_child_data</span><span class="p">(</span><span class="n">child_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_instance</span></div>

    <span class="k">def</span> <span class="nf">_set_child_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ExperimentData</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set child experiment data for the current experiment.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">child_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_child_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;child_data_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">IBMExperimentService</span><span class="p">,</span> <span class="n">replace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the service to be used for storing experiment data,</span>
<span class="sd">           to this experiment itself and its descendants.</span>

<span class="sd">        Args:</span>
<span class="sd">            service: Service to be used.</span>
<span class="sd">            replace: Should an existing service be replaced?</span>
<span class="sd">            If not, and a current service exists, exception is raised</span>

<span class="sd">        Raises:</span>
<span class="sd">            ExperimentDataError: If an experiment service is already being used and `replace==False`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">replace</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExperimentDataError</span><span class="p">(</span><span class="s2">&quot;An experiment service is already being used.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auto_save&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_data</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">_set_service</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>

<div class="viewcode-block" id="ExperimentData.add_tags_recursive"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.add_tags_recursive.html#qiskit_experiments.framework.ExperimentData.add_tags_recursive">[docs]</a>    <span class="k">def</span> <span class="nf">add_tags_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags2add</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add tags to this experiment itself and its descendants</span>

<span class="sd">        Args:</span>
<span class="sd">            tags2add - the tags that will be added to the existing tags</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">+=</span> <span class="n">tags2add</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">add_tags_recursive</span><span class="p">(</span><span class="n">tags2add</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExperimentData.remove_tags_recursive"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.remove_tags_recursive.html#qiskit_experiments.framework.ExperimentData.remove_tags_recursive">[docs]</a>    <span class="k">def</span> <span class="nf">remove_tags_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags2remove</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove tags from this experiment itself and its descendants</span>

<span class="sd">        Args:</span>
<span class="sd">            tags2remove - the tags that will be removed from the existing tags</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags2remove</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">data</span><span class="o">.</span><span class="n">remove_tags_recursive</span><span class="p">(</span><span class="n">tags2remove</span><span class="p">)</span></div>

    <span class="c1"># represetnation and serialization</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, parent_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, tags=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, job_ids=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">share_level</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, share_level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">share_level</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, metadata=&lt;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span><span class="si">}</span><span class="s2"> items&gt;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_names</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, figure_names=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">figure_names</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, notes=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">notes</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># pylint: disable=raise-missing-from</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attribute </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not defined&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_safe_serialize_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return serializable object for stored jobs&quot;&quot;&quot;</span>
        <span class="c1"># Since Job objects are not serializable this removes</span>
        <span class="c1"># them from the jobs dict and returns {job_id: None}</span>
        <span class="c1"># that can be used to retrieve jobs from a service after loading</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">jobs</span><span class="p">[</span><span class="n">jid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">jobs</span>

    <span class="k">def</span> <span class="nf">_safe_serialize_figures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return serializable object for stored figures&quot;&quot;&quot;</span>
        <span class="c1"># Convert any MPL figures into SVG images before serializing</span>
        <span class="n">figures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">figure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">Figure</span><span class="p">):</span>
                    <span class="n">figures</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_to_svg_bytes</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">figures</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">figure</span>
        <span class="k">return</span> <span class="n">figures</span>

    <span class="k">def</span> <span class="nf">__json_encode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">QiskitError</span><span class="p">(</span>
                <span class="s2">&quot;Not all experiment jobs have finished. Jobs must be &quot;</span>
                <span class="s2">&quot;cancelled or done to serialize experiment data.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="n">QiskitError</span><span class="p">(</span>
                <span class="s2">&quot;Not all experiment analysis has finished. Analysis must be &quot;</span>
                <span class="s2">&quot;cancelled or done to serialize experiment data.&quot;</span>
            <span class="p">)</span>
        <span class="n">json_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;_db_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="p">,</span>
            <span class="s2">&quot;_analysis_results&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">,</span>
            <span class="s2">&quot;_analysis_callbacks&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_callbacks</span><span class="p">,</span>
            <span class="s2">&quot;_deleted_figures&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_figures</span><span class="p">,</span>
            <span class="s2">&quot;_deleted_analysis_results&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted_analysis_results</span><span class="p">,</span>
            <span class="s2">&quot;_result_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="p">,</span>
            <span class="s2">&quot;_extra_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_data</span><span class="p">,</span>
            <span class="s2">&quot;_created_in_db&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_in_db</span><span class="p">,</span>
            <span class="s2">&quot;_figures&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_serialize_figures</span><span class="p">(),</span>  <span class="c1"># Convert figures to SVG</span>
            <span class="s2">&quot;_jobs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_serialize_jobs</span><span class="p">(),</span>  <span class="c1"># Handle non-serializable objects</span>
            <span class="s2">&quot;_experiment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_experiment</span><span class="p">,</span>
            <span class="s2">&quot;_child_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># the attribute self._service in charge of the connection and communication with the</span>
        <span class="c1">#  experiment db. It doesn&#39;t have meaning in the json format so there is no need to serialize</span>
        <span class="c1">#  it.</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;_service&quot;</span><span class="p">,</span> <span class="s2">&quot;_backend&quot;</span><span class="p">]:</span>
            <span class="n">json_value</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> cannot be JSON serialized&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">json_value</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__json_decode__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">att_val</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">att_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not all job futures have finished.&quot;</span>
                <span class="s2">&quot; Data from running futures will not be serialized.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">fut</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">for</span> <span class="n">fut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not all analysis callbacks have finished.&quot;</span>
                <span class="s2">&quot; Results from running callbacks will not be serialized.&quot;</span>
            <span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Remove non-pickleable attributes</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;_job_futures&quot;</span><span class="p">,</span> <span class="s2">&quot;_analysis_futures&quot;</span><span class="p">,</span> <span class="s2">&quot;_analysis_executor&quot;</span><span class="p">,</span> <span class="s2">&quot;_monitor_executor&quot;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Convert figures to SVG</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;_figures&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_serialize_figures</span><span class="p">()</span>

        <span class="c1"># Handle partially pickleable attributes</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;_jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_serialize_jobs</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">state</span>

<div class="viewcode-block" id="ExperimentData.get_service_from_backend"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentData.get_service_from_backend.html#qiskit_experiments.framework.ExperimentData.get_service_from_backend">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_service_from_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the server from the backend data&quot;&quot;&quot;</span>
        <span class="n">db_url</span> <span class="o">=</span> <span class="s2">&quot;https://auth.quantum-computing.ibm.com/api&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">provider</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">_provider</span>
            <span class="c1"># qiskit-ibmq-provider style</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="s2">&quot;credentials&quot;</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">credentials</span><span class="o">.</span><span class="n">token</span>
            <span class="c1"># qiskit-ibm-provider style</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="s2">&quot;_account&quot;</span><span class="p">):</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">_account</span><span class="o">.</span><span class="n">token</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">IBMExperimentService</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">db_url</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">service</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="c1"># Initialize non-pickled attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job_futures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_futures</span> <span class="o">=</span> <span class="n">ThreadSafeOrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_executor</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="mi">51</span> <span class="o">*</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">n_res</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analysis_results</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Experiment: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Experiment ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parent ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_data</span><span class="o">.</span><span class="n">parent_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Child Experiment Data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_child_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backend: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tags: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis Results: </span><span class="si">{</span><span class="n">n_res</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Figures: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figures</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">service_exception_to_warning</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert an exception raised by experiment service to a warning.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Experiment service operation failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>


<div class="viewcode-block" id="ExperimentStatus"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.ExperimentStatus.html#qiskit_experiments.framework.ExperimentStatus">[docs]</a><span class="k">class</span> <span class="nc">ExperimentStatus</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for experiment status enumerated type.&quot;&quot;&quot;</span>

    <span class="n">EMPTY</span> <span class="o">=</span> <span class="s2">&quot;experiment data is empty&quot;</span>
    <span class="n">INITIALIZING</span> <span class="o">=</span> <span class="s2">&quot;experiment jobs are being initialized&quot;</span>
    <span class="n">VALIDATING</span> <span class="o">=</span> <span class="s2">&quot;experiment jobs are validating&quot;</span>
    <span class="n">QUEUED</span> <span class="o">=</span> <span class="s2">&quot;experiment jobs are queued&quot;</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;experiment jobs is actively running&quot;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;experiment jobs or analysis has been cancelled&quot;</span>
    <span class="n">POST_PROCESSING</span> <span class="o">=</span> <span class="s2">&quot;experiment analysis is actively running&quot;</span>
    <span class="n">DONE</span> <span class="o">=</span> <span class="s2">&quot;experiment jobs and analysis have successfully run&quot;</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="s2">&quot;experiment jobs or analysis incurred an error&quot;</span>

    <span class="k">def</span> <span class="nf">__json_encode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__json_decode__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__members__</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span></div>


<div class="viewcode-block" id="AnalysisStatus"><a class="viewcode-back" href="../../../stubs/qiskit_experiments.framework.AnalysisStatus.html#qiskit_experiments.framework.AnalysisStatus">[docs]</a><span class="k">class</span> <span class="nc">AnalysisStatus</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for analysis callback status enumerated type.&quot;&quot;&quot;</span>

    <span class="n">QUEUED</span> <span class="o">=</span> <span class="s2">&quot;analysis callback is queued&quot;</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;analysis callback is actively running&quot;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;analysis callback has been cancelled&quot;</span>
    <span class="n">DONE</span> <span class="o">=</span> <span class="s2">&quot;analysis callback has successfully run&quot;</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="s2">&quot;analysis callback incurred an error&quot;</span>

    <span class="k">def</span> <span class="nf">__json_encode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__json_decode__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__members__</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>  <span class="c1"># pylint: disable=unsubscriptable-object</span></div>


<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">AnalysisCallback</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataclass for analysis callback status&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">callback_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">AnalysisStatus</span> <span class="o">=</span> <span class="n">AnalysisStatus</span><span class="o">.</span><span class="n">QUEUED</span>
    <span class="n">error_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">event</span><span class="p">:</span> <span class="n">Event</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We need to remove the Event object from state when pickling</span>
        <span class="c1"># since events are not pickleable</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__json_encode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
</pre></div>

             </article>
            </div>
            <footer>
<!-- USER FEEDBACK -->
  

    <hr class="helpful-hr hr-top">
      <div class="helpful-container">
        <div class="helpful-question">Was this page helpful?</div>
        <a class="helpful-question yes-link" onclick="clicked('yes')">Yes</a>
        <a class="helpful-question no-link" onclick="clicked('no')">No</a>
        <div class="was-helpful-thank-you" id="was-helpful-thank-you">Thank you!</div>
      </div>
    <hr class="helpful-hr hr-bottom"/>
  
  

  <!-- NEXT/PREVIOUS BUTTONS -->
  <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
    
    
  </div>

  <div role="contentinfo">
    <p>
    <!-- SHOW QISKIT COPYRIGHT TEXT -->
        &copy; Copyright 2021-2024, Qiskit Development Team.

    <!-- SHOW DATE PAGE LAST UPDATED -->
      Last updated on 2024/01/25.

    </p>
  </div>

<!-- SHOW 'MADE WITH SPHINX' TEXT -->
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using <a href="https://github.com/Qiskit/qiskit_sphinx_theme">Qiskit Sphinx Theme </a> (based on <a href="https://github.com/pytorch/pytorch_sphinx_theme"> PyTorch Sphinx Theme</a>).
      </div>
     
<br>
</footer>

<script>
  function clicked(ctaType) {
    document.getElementById('was-helpful-thank-you').style.visibility = 'visible';
    window.trackCta(`Helpful - ${ctaType}`);
  }
</script>

          </div>
        </div>

        <!-- RIGHT SIDE AUTOSUMMARY MENU -->
        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


  <!-- MOBILE MENU FOR SIDEBAR -->
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
      <script src="../../../_static/jquery.js"></script>
      <script src="../../../_static/underscore.js"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script src="../../../_static/doctools.js"></script>
      <script src="../../../_static/sphinx_highlight.js"></script>
      <script src="../../../_static/clipboard.min.js"></script>
      <script src="../../../_static/copybutton.js"></script>
      <script src="../../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="../../../_static/design-tabs.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

    <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <!-- enable language dropdown menu expand -->
  <script type="text/javascript">
    jQuery(function () {
        SphinxRtdTheme.Navigation.enable(true);
    });
  </script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>

</body>
</html>